name: Check Upstream Updates

# upstreamã®æ›´æ–°ã‚’é€±æ¬¡ã§ãƒã‚§ãƒƒã‚¯ï¼ˆé€šçŸ¥ã®ã¿ã€ãƒãƒ¼ã‚¸ã¯ã—ãªã„ï¼‰
on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯é€±æ—¥æ›œæ—¥ 0:00 UTC
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      issues: write  # Issueä½œæˆã«å¿…è¦
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/Akira-Papa/claude-code-action.git || true

      - name: Fetch upstream
        run: git fetch upstream

      - name: Check for updates
        id: check
        run: |
          # upstreamã®mainã¨ç¾åœ¨ã®mainã‚’æ¯”è¼ƒ
          COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT

          if [ "$COMMITS_BEHIND" -gt 0 ]; then
            echo "âš ï¸ Upstream is $COMMITS_BEHIND commits ahead"
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # å¤‰æ›´å†…å®¹ã‚’å–å¾—
            git log --oneline HEAD..upstream/main > /tmp/upstream_changes.txt

            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
            git diff --name-only HEAD..upstream/main > /tmp/changed_files.txt
          else
            echo "âœ… No updates from upstream"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Check conflicts with custom changes
        if: steps.check.outputs.has_updates == 'true'
        id: conflict_check
        run: |
          # ç‹¬è‡ªå¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
          CUSTOM_FILES="src/github/context.ts"

          CONFLICT_WARNING=""
          for file in $CUSTOM_FILES; do
            if git diff --name-only HEAD..upstream/main | grep -q "^$file$"; then
              CONFLICT_WARNING="${CONFLICT_WARNING}âš ï¸ \`$file\` has changes in upstream (may conflict with custom changes)\n"
            fi
          done

          if [ -n "$CONFLICT_WARNING" ]; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "conflict_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$CONFLICT_WARNING" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          fi

      - name: Create notification issue
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changes = fs.readFileSync('/tmp/upstream_changes.txt', 'utf8');
            const changedFiles = fs.readFileSync('/tmp/changed_files.txt', 'utf8');

            const hasConflicts = '${{ steps.conflict_check.outputs.has_conflicts }}' === 'true';
            const conflictWarning = hasConflicts
              ? `\n### âš ï¸ ç«¶åˆã®å¯èƒ½æ€§\n\n${{ steps.conflict_check.outputs.conflict_files }}\n\nç‹¬è‡ªå¤‰æ›´ã¨ç«¶åˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚åŒæœŸæ™‚ã¯æ…é‡ã«å¯¾å¿œã—ã¦ãã ã•ã„ã€‚\n`
              : '';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”” Upstream has ${{ steps.check.outputs.commits_behind }} new commits`,
              body: `## Upstreamæ›´æ–°é€šçŸ¥

[Akira-Papa/claude-code-action](https://github.com/Akira-Papa/claude-code-action)ã«æ–°ã—ã„æ›´æ–°ãŒã‚ã‚Šã¾ã™ã€‚

### ğŸ“Š æ›´æ–°ã‚µãƒãƒªãƒ¼

- **ã‚³ãƒŸãƒƒãƒˆæ•°:** ${{ steps.check.outputs.commits_behind }} commits
- **ç«¶åˆãƒªã‚¹ã‚¯:** ${hasConflicts ? 'âš ï¸ ã‚ã‚Š' : 'âœ… ãªã—'}
${conflictWarning}
### ğŸ“ æ›´æ–°å†…å®¹

\`\`\`
${changes}
\`\`\`

### ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

\`\`\`
${changedFiles}
\`\`\`

---

## ğŸ”„ æ‰‹å‹•ã§åŒæœŸã™ã‚‹æ–¹æ³•

### Step 1: å·®åˆ†ã‚’ç¢ºèª

\`\`\`bash
cd /home/u5/project/claude-code-action

# upstreamã®æœ€æ–°ã‚’å–å¾—
git fetch upstream

# ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’ç¢ºèª
git log --oneline HEAD..upstream/main

# è©³ç´°ãªå·®åˆ†ã‚’ç¢ºèª
git diff HEAD..upstream/main

# ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ã‚’ç¢ºèªï¼ˆä¾‹: context.tsï¼‰
git diff HEAD..upstream/main -- src/github/context.ts
\`\`\`

### Step 2: ç‹¬è‡ªå¤‰æ›´ã¸ã®å½±éŸ¿ã‚’è©•ä¾¡

**ç‹¬è‡ªå¤‰æ›´ã‚’ç¢ºèª:**
- \`src/github/context.ts\` - repository_dispatchå¯¾å¿œ
- è©³ç´°ã¯ [FORK_CHANGES.md](https://github.com/${{ github.repository }}/blob/main/FORK_CHANGES.md) ã‚’å‚ç…§

**è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆ:**
- [ ] upstreamã®å¤‰æ›´ãŒç‹¬è‡ªå¤‰æ›´ã¨ç«¶åˆã—ãªã„ã‹ï¼Ÿ
- [ ] æ–°æ©Ÿèƒ½ãŒå¿…è¦ã‹ï¼Ÿ
- [ ] ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å•é¡Œãªãå‹•ä½œã—ã¦ã„ã‚‹ã‹ï¼Ÿ

### Step 3: åŒæœŸã‚’å®Ÿè¡Œï¼ˆå•é¡Œãªã‘ã‚Œã°ï¼‰

\`\`\`bash
# åŒæœŸãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
git checkout -b upstream-sync-$(date +%Y%m%d)

# ãƒãƒ¼ã‚¸
git merge upstream/main

# ç«¶åˆãŒã‚ã‚Œã°è§£æ±º
# âš ï¸ ç«¶åˆè§£æ±ºæ™‚ã¯å¿…ãšç‹¬è‡ªå¤‰æ›´ã‚’ä¿æŒã™ã‚‹ã“ã¨
# - src/github/context.ts ã® repository_dispatch å¯¾å¿œã‚’ç¶­æŒ
# - åˆ†ã‹ã‚‰ãªã„å ´åˆã¯ upstream/main ã®å†…å®¹ã‚’ä¸€æ—¦ç ´æ£„ã—ã¦æ‰‹å‹•ã§å†å®Ÿè£…

# è§£æ±ºå¾Œ
git add .
git commit

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå¿…é ˆï¼ï¼‰
npm install
npm run typecheck

# å•é¡Œãªã‘ã‚Œã°mainã«ãƒãƒ¼ã‚¸
git checkout main
git merge upstream-sync-$(date +%Y%m%d)
git push origin main

# åŒæœŸãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤
git branch -d upstream-sync-$(date +%Y%m%d)
\`\`\`

### Step 4: å‹•ä½œç¢ºèª

\`\`\`bash
# notehub-infraã§å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆ
cd /home/u5/project/notehub-infra

# Turn 1ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œ
# repository_dispatchçµŒç”±ã§ãƒˆãƒªã‚¬ãƒ¼ã—ã¦å‹•ä½œç¢ºèª
\`\`\`

---

## âš ï¸ åŒæœŸã‚’è¦‹é€ã‚‹åˆ¤æ–­åŸºæº–

ä»¥ä¸‹ã®å ´åˆã¯åŒæœŸã‚’è¦‹é€ã‚‹ã“ã¨ã‚‚æ¤œè¨ã—ã¦ãã ã•ã„ï¼š

- âœ‹ upstreamã®å¤‰æ›´ãŒç‹¬è‡ªå¤‰æ›´ï¼ˆrepository_dispatchå¯¾å¿œï¼‰ã¨ç«¶åˆã™ã‚‹
- âœ‹ ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å®‰å®šã—ã¦å‹•ä½œã—ã¦ã„ã‚‹
- âœ‹ upstreamã®æ–°æ©Ÿèƒ½ãŒä¸è¦
- âœ‹ ç«¶åˆè§£æ±ºã«è‡ªä¿¡ãŒãªã„ï¼ˆå¾Œæ—¥å¯¾å¿œã§ã‚‚å¯ï¼‰

**é‡è¦:** ç„¡ç†ã«åŒæœŸã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¿…è¦æ€§ã¨ãƒªã‚¹ã‚¯ã‚’å¤©ç§¤ã«ã‹ã‘ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚

---

## ğŸ“š å‚è€ƒæƒ…å ±

### ç‹¬è‡ªå¤‰æ›´ã®è©³ç´°
- [FORK_CHANGES.md](https://github.com/${{ github.repository }}/blob/main/FORK_CHANGES.md)

### ç«¶åˆè§£æ±ºã®ãƒ˜ãƒ«ãƒ—
- [Gitå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - ãƒãƒ¼ã‚¸ã®ç«¶åˆã‚’è§£æ±ºã™ã‚‹](https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E6%A9%9F%E8%83%BD-%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%A8%E3%83%9E%E3%83%BC%E3%82%B8%E3%81%AE%E5%9F%BA%E6%9C%AC#_basic_merge_conflicts)

### upstreamãƒªãƒã‚¸ãƒˆãƒª
- https://github.com/Akira-Papa/claude-code-action

---

ğŸ¤– è‡ªå‹•ç”ŸæˆIssue by GitHub Actions

**ã“ã®Issueã®å¯¾å¿œ:**
- å†…å®¹ã‚’ç¢ºèªã—ã¦ã€åŒæœŸãŒå¿…è¦ã‹åˆ¤æ–­ã—ã¦ãã ã•ã„
- åŒæœŸã‚’è¦‹é€ã‚‹å ´åˆã¯ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„
- åŒæœŸã—ãŸå ´åˆã¯ã€ã“ã®Issueã«çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„`,
              labels: ['upstream-check', 'notification']
            });
